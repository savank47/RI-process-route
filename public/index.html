<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Parts Production Tracker Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üè≠</text></svg>">
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 600; }
        .process-chip { transition: all 0.2s ease; cursor: grab; }
        .process-chip:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .process-chip.selected { border-color: #3b82f6; background-color: #eff6ff; }
        .process-chip:active { cursor: grabbing; }
        .sortable-item { cursor: grab; }
        .sortable-item:active { cursor: grabbing; }
        .sortable-item.dragging { opacity: 0.5; }
        .status-pending { background-color: #fef3c7; border-left: 4px solid #f59e0b; }
        .status-inprogress { background-color: #dbeafe; border-left: 4px solid #3b82f6; }
        .status-completed { background-color: #d1fae5; border-left: 4px solid #10b981; }
        .status-defect { background-color: #fee2e2; border-left: 4px solid #ef4444; }
        .batch-card { transition: all 0.2s ease; }
        .batch-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .process-route-step { transition: all 0.3s ease; }
        .process-route-step.completed { background-color: #d1fae5; }
        .process-route-step.inprogress { background-color: #dbeafe; }
        .process-route-step.defect { background-color: #fee2e2; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulse { animation: pulse 2s infinite; }
        input:focus, select:focus, textarea:focus { outline: none; ring: 2px; ring-color: #3b82f6; }
        .drop-zone { border: 2px dashed #d1d5db; transition: all 0.2s ease; }
        .drop-zone.drag-over { border-color: #3b82f6; background-color: #eff6ff; }
        .loader { border: 3px solid #f3f4f6; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .api-status { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #10b981; }
        .api-status.offline { background: #ef4444; }
        .api-status.connecting { background: #f59e0b; animation: pulse 1s infinite; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen pb-12">
        <!-- Header -->
        <header class="bg-gradient-to-r from-indigo-600 via-blue-600 to-cyan-500 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold flex items-center gap-3">
                            <i class="fas fa-industry"></i>
                            Auto Parts Production Tracker <span class="bg-white/20 px-3 py-1 rounded-full text-sm">PRO</span>
                        </h1>
                        <p class="text-blue-100 mt-1">Master your processes, items, and production batches</p>
                    </div>
                    <div class="hidden md:block text-right">
                        <div class="flex items-center gap-2 justify-end mb-1">
                            <div id="apiStatus" class="api-status connecting"></div>
                            <span id="apiStatusText" class="text-sm text-blue-100">Connecting...</span>
                        </div>
                        <p class="text-sm text-blue-100"><i class="fas fa-clock mr-2"></i><span id="currentTime"></span></p>
                        <p class="text-xs text-blue-200 mt-1"><span id="todayDate"></span></p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="bg-white border-b border-gray-200 shadow-sm">
            <div class="container mx-auto px-4 py-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="flex items-center gap-3 bg-indigo-50 rounded-lg p-3">
                        <div class="bg-indigo-600 text-white rounded-lg p-2">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600">Processes</p>
                            <p class="text-xl font-bold text-gray-800" id="statProcesses">0</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 bg-green-50 rounded-lg p-3">
                        <div class="bg-green-600 text-white rounded-lg p-2">
                            <i class="fas fa-box"></i>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600">Items</p>
                            <p class="text-xl font-bold text-gray-800" id="statItems">0</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 bg-blue-50 rounded-lg p-3">
                        <div class="bg-blue-600 text-white rounded-lg p-2">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600">Active Batches</p>
                            <p class="text-xl font-bold text-gray-800" id="statActiveBatches">0</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 bg-amber-50 rounded-lg p-3">
                        <div class="bg-amber-600 text-white rounded-lg p-2">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600">Completed</p>
                            <p class="text-xl font-bold text-gray-800" id="statCompletedBatches">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-10 shadow-sm">
            <div class="container mx-auto px-4">
                <div class="flex space-x-1 overflow-x-auto">
                    <button onclick="showTab('processes')" id="tab-processes" class="tab-active py-4 px-4 text-sm font-medium transition whitespace-nowrap">
                        <i class="fas fa-cogs mr-2"></i>Process Library
                    </button>
                    <button onclick="showTab('items')" id="tab-items" class="py-4 px-4 text-sm font-medium text-gray-600 hover:text-blue-600 transition whitespace-nowrap">
                        <i class="fas fa-boxes mr-2"></i>Items Master
                    </button>
                    <button onclick="showTab('batches')" id="tab-batches" class="py-4 px-4 text-sm font-medium text-gray-600 hover:text-blue-600 transition whitespace-nowrap">
                        <i class="fas fa-layer-group mr-2"></i>Production Batches
                    </button>
                    <button onclick="showTab('tracking')" id="tab-tracking" class="py-4 px-4 text-sm font-medium text-gray-600 hover:text-blue-600 transition whitespace-nowrap">
                        <i class="fas fa-tasks mr-2"></i>Batch Tracking
                    </button>
                    <button onclick="showTab('dashboard')" id="tab-dashboard" class="py-4 px-4 text-sm font-medium text-gray-600 hover:text-blue-600 transition whitespace-nowrap">
                        <i class="fas fa-chart-line mr-2"></i>Dashboard
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            
            <!-- PROCESS LIBRARY TAB -->
            <div id="content-processes" class="animate-slide-in">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-plus-circle mr-2 text-indigo-600"></i>Add New Process to Library</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="processName" placeholder="Process Name (e.g., CNC Machining)" class="border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500">
                        <input type="text" id="processCode" placeholder="Process Code (e.g., CNC-01)" class="border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="mt-4">
                        <input type="text" id="processDescription" placeholder="Description (e.g., CNC precision machining operation)" class="border border-gray-300 rounded-lg px-4 py-3 w-full focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Color Tag:</label>
                        <div class="flex gap-2 flex-wrap" id="colorPicker">
                            <button type="button" onclick="selectColor('gray')" class="color-btn w-8 h-8 rounded-full bg-gray-500 border-2 border-transparent hover:border-gray-800" data-color="gray"></button>
                            <button type="button" onclick="selectColor('red')" class="color-btn w-8 h-8 rounded-full bg-red-500 border-2 border-transparent hover:border-red-800" data-color="red"></button>
                            <button type="button" onclick="selectColor('orange')" class="color-btn w-8 h-8 rounded-full bg-orange-500 border-2 border-transparent hover:border-orange-800" data-color="orange"></button>
                            <button type="button" onclick="selectColor('amber')" class="color-btn w-8 h-8 rounded-full bg-amber-500 border-2 border-transparent hover:border-amber-800" data-color="amber"></button>
                            <button type="button" onclick="selectColor('green')" class="color-btn w-8 h-8 rounded-full bg-green-500 border-2 border-transparent hover:border-green-800" data-color="green"></button>
                            <button type="button" onclick="selectColor('teal')" class="color-btn w-8 h-8 rounded-full bg-teal-500 border-2 border-transparent hover:border-teal-800" data-color="teal"></button>
                            <button type="button" onclick="selectColor('blue')" class="color-btn w-8 h-8 rounded-full bg-blue-500 border-2 border-transparent hover:border-blue-800" data-color="blue"></button>
                            <button type="button" onclick="selectColor('indigo')" class="color-btn w-8 h-8 rounded-full bg-indigo-500 border-2 border-transparent hover:border-indigo-800" data-color="indigo"></button>
                            <button type="button" onclick="selectColor('purple')" class="color-btn w-8 h-8 rounded-full bg-purple-500 border-2 border-transparent hover:border-purple-800" data-color="purple"></button>
                            <button type="button" onclick="selectColor('pink')" class="color-btn w-8 h-8 rounded-full bg-pink-500 border-2 border-transparent hover:border-pink-800" data-color="pink"></button>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-3">
                        <button onclick="addProcess()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-6 py-3 rounded-lg transition shadow-md">
                            <i class="fas fa-plus mr-2"></i>Add to Library
                        </button>
                        <button onclick="loadDefaultProcesses()" class="bg-gray-600 hover:bg-gray-700 text-white font-medium px-6 py-3 rounded-lg transition shadow-md">
                            <i class="fas fa-magic mr-2"></i>Load Default Processes
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-list mr-2 text-indigo-600"></i>Process Library</h2>
                    <div id="processesList" class="flex flex-wrap gap-3"></div>
                </div>
            </div>

            <!-- ITEMS TAB -->
            <div id="content-items" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-plus-circle mr-2 text-green-600"></i>Create New Item</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="itemName" placeholder="Item Name (e.g., Brake Disc)" class="border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500">
                        <input type="text" id="itemCode" placeholder="Item Code (e.g., BD-001)" class="border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500">
                        <input type="text" id="itemSpec" placeholder="Specifications" class="border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500">
                    </div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="itemMaterial" placeholder="Material (e.g., Cast Iron, Steel)" class="border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500">
                        <input type="text" id="itemCategory" placeholder="Category (e.g., Brakes, Engine)" class="border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500">
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="font-semibold text-gray-700 mb-3"><i class="fas fa-route mr-2"></i>Define Process Route for This Item</h3>
                        <p class="text-sm text-gray-500 mb-3">Click on processes from the library to add them to the route. Drag to reorder.</p>
                        
                        <!-- Available Processes -->
                        <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Available Processes (Click to Add):</h4>
                            <div id="availableProcessesForItem" class="flex flex-wrap gap-2"></div>
                        </div>
                        
                        <!-- Selected Process Route -->
                        <div class="p-4 bg-indigo-50 rounded-lg border-2 border-dashed border-indigo-200 drop-zone" id="processRouteZone">
                            <h4 class="text-sm font-medium text-gray-700 mb-2"><i class="fas fa-list-ol mr-2"></i>Process Route (Drag to Reorder):</h4>
                            <div id="selectedProcessRoute" class="flex flex-wrap gap-2 min-h-[60px]"></div>
                            <p id="emptyRouteMessage" class="text-sm text-gray-400 italic">No processes selected yet. Click on available processes above.</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 flex gap-3">
                        <button onclick="addItem()" class="bg-green-600 hover:bg-green-700 text-white font-medium px-6 py-3 rounded-lg transition shadow-md">
                            <i class="fas fa-save mr-2"></i>Save Item
                        </button>
                        <button onclick="clearItemForm()" class="bg-gray-500 hover:bg-gray-600 text-white font-medium px-6 py-3 rounded-lg transition shadow-md">
                            <i class="fas fa-times mr-2"></i>Clear Form
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-boxes mr-2 text-green-600"></i>Items List</h2>
                    <div id="itemsList" class="space-y-4"></div>
                </div>
            </div>

            <!-- BATCHES TAB -->
            <div id="content-batches" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-plus-circle mr-2 text-blue-600"></i>Create New Production Batch</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Batch Number:</label>
                            <input type="text" id="batchNumber" placeholder="e.g., BATCH-2024-001" class="border border-gray-300 rounded-lg px-4 py-3 w-full focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Quantity:</label>
                            <input type="number" id="batchQuantity" placeholder="e.g., 100" min="1" class="border border-gray-300 rounded-lg px-4 py-3 w-full focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Priority:</label>
                            <select id="batchPriority" class="border border-gray-300 rounded-lg px-4 py-3 w-full focus:ring-2 focus:ring-blue-500">
                                <option value="normal">Normal</option>
                                <option value="high">High Priority</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Target Date:</label>
                            <input type="date" id="batchTargetDate" class="border border-gray-300 rounded-lg px-4 py-3 w-full focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Select Item:</label>
                        <select id="batchItemSelect" onchange="previewBatchProcessRoute()" class="border border-gray-300 rounded-lg px-4 py-3 w-full focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Select Item --</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Customer/Order Reference (Optional):</label>
                        <input type="text" id="batchCustomer" placeholder="e.g., Order #12345 or Customer Name" class="border border-gray-300 rounded-lg px-4 py-3 w-full focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div id="processRoutePreview" class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200 hidden">
                        <h4 class="font-semibold text-gray-800 mb-3"><i class="fas fa-route mr-2"></i>Process Route Preview:</h4>
                        <div id="routePreviewSteps" class="space-y-2"></div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="createBatch()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-3 rounded-lg transition shadow-md">
                            <i class="fas fa-play mr-2"></i>Create Batch
                        </button>
                        <button onclick="clearBatchForm()" class="bg-gray-500 hover:bg-gray-600 text-white font-medium px-6 py-3 rounded-lg transition shadow-md">
                            <i class="fas fa-times mr-2"></i>Clear Form
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-layer-group mr-2 text-blue-600"></i>Production Batches</h2>
                        <select id="batchFilter" onchange="filterBatches()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            <option value="all">All Batches</option>
                            <option value="active">Active Only</option>
                            <option value="completed">Completed Only</option>
                        </select>
                    </div>
                    <div id="batchesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
            </div>

            <!-- TRACKING TAB -->
            <div id="content-tracking" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-tasks mr-2 text-purple-600"></i>Track Batch Progress</h2>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Select Batch to Track:</label>
                        <select id="trackingBatchSelect" onchange="loadBatchTracking()" class="border border-gray-300 rounded-lg px-4 py-3 w-full md:w-1/2 focus:ring-2 focus:ring-purple-500">
                            <option value="">-- Select Batch --</option>
                        </select>
                    </div>
                    <div id="trackingDisplay" class="hidden">
                        <div class="mb-6 p-4 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg border border-purple-200">
                            <div id="batchInfo" class="font-semibold text-gray-800"></div>
                        </div>
                        
                        <!-- Progress Overview -->
                        <div class="mb-6">
                            <div class="flex justify-between text-sm text-gray-600 mb-2">
                                <span>Overall Progress</span>
                                <span id="overallProgressText">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div id="overallProgressBar" class="bg-gradient-to-r from-blue-500 to-green-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                            <h4 class="font-semibold text-gray-700 mb-2"><i class="fas fa-bolt mr-2"></i>Quick Actions:</h4>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="event.preventDefault(); startFirstPendingProcess()" class="px-4 py-2 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded-lg text-sm transition">
                                    <i class="fas fa-play mr-1"></i>Start Next Process
                                </button>
                                <button onclick="event.preventDefault(); completeCurrentProcess()" class="px-4 py-2 bg-green-100 hover:bg-green-200 text-green-800 rounded-lg text-sm transition">
                                    <i class="fas fa-check mr-1"></i>Complete Current
                                </button>
                                <button onclick="event.preventDefault(); resetAllProcesses()" class="px-4 py-2 bg-amber-100 hover:bg-amber-200 text-amber-800 rounded-lg text-sm transition">
                                    <i class="fas fa-redo mr-1"></i>Reset All
                                </button>
                            </div>
                        </div>

                        <!-- Process Steps -->
                        <div id="processTracking" class="space-y-3"></div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-list-alt mr-2 text-purple-600"></i>All Batches Summary</h2>
                    <div id="batchSummary" class="space-y-3"></div>
                </div>
            </div>

            <!-- DASHBOARD TAB -->
            <div id="content-dashboard" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-chart-pie mr-2 text-indigo-600"></i>Batch Status Overview</h2>
                        <div id="statusChart" class="flex items-center justify-center h-64"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-exclamation-triangle mr-2 text-amber-600"></i>Defect Report</h2>
                        <div id="defectReport" class="space-y-2"></div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-clock mr-2 text-blue-600"></i>Recent Activity</h2>
                    <div id="recentActivity" class="space-y-3"></div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-trophy mr-2 text-yellow-600"></i>Top Performing Items</h2>
                    <div id="topItems" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-6 mt-12">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="text-center md:text-left mb-4 md:mb-0">
                        <p class="font-semibold">Auto Parts Production Tracker Pro ¬© 2024</p>
                        <p class="text-xs text-gray-400 mt-1">Backend: Node.js + MongoDB | Deployed on Railway</p>
                    </div>
                    <div class="flex gap-3 flex-wrap justify-center">
                        <button onclick="exportData()" class="bg-green-600 hover:bg-green-700 text-white text-sm px-4 py-2 rounded-lg transition">
                            <i class="fas fa-download mr-2"></i>Export Data
                        </button>
                        <button onclick="document.getElementById('importFile').click()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded-lg transition">
                            <i class="fas fa-upload mr-2"></i>Import Data
                        </button>
                        <input type="file" id="importFile" accept=".json" onchange="importData(event)" class="hidden">
                    </div>
                </div>
            </div>
        </footer>

        <!-- Toast Notification -->
        <div id="toast" class="fixed bottom-4 right-4 transform translate-y-20 opacity-0 transition-all duration-300 z-50">
            <div class="bg-white rounded-lg shadow-xl p-4 flex items-center gap-3">
                <i id="toastIcon" class="fas fa-check-circle text-green-500 text-xl"></i>
                <div>
                    <p id="toastMessage" class="font-medium text-gray-800"></p>
                </div>
            </div>
        </div>

        <!-- Process Edit Modal -->
        <div id="editModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                <h3 class="text-lg font-bold mb-4">Edit Process</h3>
                <input type="hidden" id="editProcessId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                        <input type="text" id="editProcessName" class="border border-gray-300 rounded-lg px-4 py-2 w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Code</label>
                        <input type="text" id="editProcessCode" class="border border-gray-300 rounded-lg px-4 py-2 w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <input type="text" id="editProcessDesc" class="border border-gray-300 rounded-lg px-4 py-2 w-full">
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="saveProcessEdit()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg">Save</button>
                    <button onclick="closeEditModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        // API Configuration - Update this after Vercel deployment
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:3000/api' 
            : `${window.location.origin}/api`; // Auto-detect deployed URL

        let selectedColor = 'blue';
        let selectedProcessesForRoute = [];

        // API Status Checker
        async function checkAPIStatus() {
            const statusEl = document.getElementById('apiStatus');
            const statusText = document.getElementById('apiStatusText');
            
            try {
                const response = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    mode: 'cors',
                    timeout: 5000
                });
                
                if (response.ok) {
                    statusEl.className = 'api-status';
                    statusText.textContent = 'Connected';
                    return true;
                }
            } catch (error) {
                statusEl.className = 'api-status offline';
                statusText.textContent = 'Offline (Local Mode)';
                console.log('API not available, using localStorage');
            }
            return false;
        }

        // Generic API calls
        async function apiCall(endpoint, method = 'GET', data = null) {
          const options = {
            method: method,
            headers: {
              'Content-Type': 'application/json',
            },
            mode: 'cors'
          };
          
          if (data) {
            options.body = JSON.stringify(data);
          }
        
          try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
            
            if (!response.ok) {
              let errorData;
              const contentType = response.headers.get('content-type');
              
              try {
                if (contentType && contentType.includes('application/json')) {
                  errorData = await response.json();
                } else {
                  errorData = await response.text();
                }
              } catch (parseError) {
                errorData = `Status: ${response.status}`;
              }
              
              throw new Error(`HTTP error! status: ${response.status}, details: ${JSON.stringify(errorData)}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
              return await response.json();
            } else {
              const text = await response.text();
              try {
                return JSON.parse(text);
              } catch {
                return text;
              }
            }
          } catch (error) {
            console.error('API call failed:', error.message);
            // Only fallback to localStorage for GET requests
            if (method === 'GET') {
              return useLocalStorageFallback(endpoint, method, data);
            }
            throw error;
          }
        }
        // LocalStorage Fallback
        function useLocalStorageFallback(endpoint, method, data) {
            const storageKey = `appData${endpoint.replace(/\/api\/(\w+).*/, '$1')}`;
            
            if (method === 'GET') {
                const data = localStorage.getItem(storageKey);
                return data ? JSON.parse(data) : [];
            } else if (method === 'POST') {
                const existing = JSON.parse(localStorage.getItem(storageKey) || '[]');
                existing.unshift(data);
                localStorage.setItem(storageKey, JSON.stringify(existing));
                return data;
            }
            return null;
        }

        // Update time display
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
            document.getElementById('todayDate').textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        // Update statistics
        async function updateStats() {
            try {
                const processes = await apiCall('/processes', 'GET');
                const items = await apiCall('/items', 'GET');
                const batches = await apiCall('/batches', 'GET');

                document.getElementById('statProcesses').textContent = processes.length;
                document.getElementById('statItems').textContent = items.length;
                document.getElementById('statActiveBatches').textContent = batches.filter(b => !b.completedAt).length;
                document.getElementById('statCompletedBatches').textContent = batches.filter(b => b.completedAt).length;
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Tab navigation
        function showTab(tabName) {
            const tabs = ['processes', 'items', 'batches', 'tracking', 'dashboard'];
            tabs.forEach(tab => {
                document.getElementById(`content-${tab}`).classList.add('hidden');
                document.getElementById(`tab-${tab}`).classList.remove('tab-active');
                document.getElementById(`tab-${tab}`).classList.add('text-gray-600');
            });
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            document.getElementById(`tab-${tabName}`).classList.remove('text-gray-600');
        
            // Load data when switching tabs
            if (tabName === 'processes') {
                renderProcessesList(); // Add this line
            } else if (tabName === 'items') {
                renderAvailableProcessesForItem();
                renderItemsList();
            } else if (tabName === 'batches') {
                updateBatchItemSelect();
                renderBatchesList();
            } else if (tabName === 'tracking') {
                updateTrackingBatchSelect();
                renderBatchSummary();
            } else if (tabName === 'dashboard') {
                renderDashboard();
            }
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');
            
            msg.textContent = message;
            icon.className = type === 'success' ? 'fas fa-check-circle text-green-500 text-xl' :
                             type === 'error' ? 'fas fa-exclamation-circle text-red-500 text-xl' :
                             'fas fa-info-circle text-blue-500 text-xl';
            
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // Color selection
        function selectColor(color) {
            selectedColor = color;
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.remove('border-gray-800', 'ring-2', 'ring-offset-2');
                if (btn.dataset.color === color) {
                    btn.classList.add('ring-2', 'ring-offset-2', 'ring-gray-800');
                }
            });
        }

        // ============ PROCESS LIBRARY ============
        async function addProcess() {
            const name = document.getElementById('processName').value.trim();
            const code = document.getElementById('processCode').value.trim();
            const description = document.getElementById('processDescription').value.trim();
        
            if (!name || !code) {
                showToast('Please enter process name and code', 'error');
                return;
            }
        
            const process = {
                name,
                code,
                description,
                color: selectedColor
            };
        
            try {
                console.log('Adding process:', process);
                const result = await apiCall('/processes', 'POST', process);
                console.log('Process added:', result);
                
                // Clear form
                document.getElementById('processName').value = '';
                document.getElementById('processCode').value = '';
                document.getElementById('processDescription').value = '';
                
                // Re-render the list
                await renderProcessesList();
                await updateStats();
                showToast(`Process "${name}" added to library!`);
            } catch (error) {
                console.error('Failed to add process:', error);
                showToast('Failed to add process: ' + error.message, 'error');
            }
        }

        const defaultProcesses = [
            { name: 'Raw Material Acquisition', code: 'RMA-001', description: 'Procurement and inspection of raw materials', color: 'gray' },
            { name: 'Cutting', code: 'CUT-001', description: 'Initial cutting of raw material to size', color: 'orange' },
            { name: 'Forging', code: 'FRG-001', description: 'Shaping metal through compressive forces', color: 'red' },
            { name: 'CNC', code: 'CNC-001', description: 'Computer Numerical Control machining', color: 'blue' },
            { name: 'VMC', code: 'VMC-001', description: 'Vertical Machining Center operations', color: 'indigo' },
            { name: 'Heat Treatment', code: 'HTT-001', description: 'Thermal processing for material properties', color: 'amber' },
            { name: 'Grinding', code: 'GRD-001', description: 'Precision surface finishing', color: 'teal' },
            { name: 'Quality Check', code: 'QCI-001', description: 'Inspection and quality verification', color: 'purple' },
            { name: 'Packaging', code: 'PKG-001', description: 'Final packaging for shipment', color: 'green' },
            { name: 'Dispatch', code: 'DSP-001', description: 'Shipping and delivery', color: 'pink' }
        ];

         async function loadDefaultProcesses() {
            if (!confirm('This will add default processes to your library. Continue?')) return;
            
            try {
                for (const proc of defaultProcesses) {
                    console.log('Loading default process:', proc.name);
                    await apiCall('/processes', 'POST', proc);
                }
                
                await renderProcessesList();
                await updateStats();
                showToast('Default processes loaded!');
            } catch (error) {
                console.error('Failed to load default processes:', error);
                showToast('Failed to load default processes: ' + error.message, 'error');
            }
        }

        async function deleteProcess(processId) {
            if (!confirm('Delete this process? It will be removed from all items using it.')) return;
            
            await apiCall(`/processes/${processId}`, 'DELETE');
            await renderProcessesList();
            await updateStats();
            showToast('Process deleted');
        }

        function editProcess(processId) {
            // This would populate the edit modal - simplified for now
            document.getElementById('editProcessId').value = processId;
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        async function saveProcessEdit() {
            const processId = document.getElementById('editProcessId').value;
            const updates = {
                name: document.getElementById('editProcessName').value,
                code: document.getElementById('editProcessCode').value,
                description: document.getElementById('editProcessDesc').value
            };

            await apiCall(`/processes/${processId}`, 'PUT', updates);
            await renderProcessesList();
            closeEditModal();
            showToast('Process updated!');
        }

            async function renderProcessesList() {
                const container = document.getElementById('processesList');
                
                try {
                    const processes = await apiCall('/processes', 'GET');
                    
                    console.log('Rendering processes:', processes); // Debug log
                    
                    if (!processes || processes.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-8 w-full">No processes in library. Add your first process above or load default processes.</p>';
                        return;
                    }
            
                    const colorClasses = {
                        gray: 'bg-gray-100 text-gray-800 border-gray-300',
                        red: 'bg-red-100 text-red-800 border-red-300',
                        orange: 'bg-orange-100 text-orange-800 border-orange-300',
                        amber: 'bg-amber-100 text-amber-800 border-amber-300',
                        green: 'bg-green-100 text-green-800 border-green-300',
                        teal: 'bg-teal-100 text-teal-800 border-teal-300',
                        blue: 'bg-blue-100 text-blue-800 border-blue-300',
                        indigo: 'bg-indigo-100 text-indigo-800 border-indigo-300',
                        purple: 'bg-purple-100 text-purple-800 border-purple-300',
                        pink: 'bg-pink-100 text-pink-800 border-pink-300'
                    };
            
                    container.innerHTML = processes.map(proc => `
                        <div class="process-chip ${colorClasses[proc.color] || colorClasses.blue} border-2 rounded-lg px-4 py-2 flex items-center gap-2">
                            <span class="font-semibold">${proc.name}</span>
                            <span class="text-xs opacity-75">${proc.code}</span>
                            ${proc.description ? `<span class="text-xs opacity-60 ml-1">(${proc.description})</span>` : ''}
                            <button onclick="deleteProcess('${proc._id}')" class="ml-auto opacity-50 hover:opacity-100 transition" title="Delete process">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                    `).join('');
                    
                    console.log('Processes rendered successfully');
                } catch (error) {
                    console.error('Error rendering processes:', error);
                    container.innerHTML = '<p class="text-red-500 text-center py-8">Error loading processes. Check console for details.</p>';
                }
            }

        // ============ ITEMS MANAGEMENT ============
        async function renderAvailableProcessesForItem() {
            const container = document.getElementById('availableProcessesForItem');
            const processes = await apiCall('/processes', 'GET');
            
            if (processes.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-400">No processes available. Add processes to the library first.</p>';
                return;
            }

            const colorClasses = {
                gray: 'bg-gray-200 text-gray-800 hover:bg-gray-300',
                red: 'bg-red-200 text-red-800 hover:bg-red-300',
                orange: 'bg-orange-200 text-orange-800 hover:bg-orange-300',
                amber: 'bg-amber-200 text-amber-800 hover:bg-amber-300',
                green: 'bg-green-200 text-green-800 hover:bg-green-300',
                teal: 'bg-teal-200 text-teal-800 hover:bg-teal-300',
                blue: 'bg-blue-200 text-blue-800 hover:bg-blue-300',
                indigo: 'bg-indigo-200 text-indigo-800 hover:bg-indigo-300',
                purple: 'bg-purple-200 text-purple-800 hover:bg-purple-300',
                pink: 'bg-pink-200 text-pink-800 hover:bg-pink-300'
            };

            container.innerHTML = processes.map(proc => {
                const isSelected = selectedProcessesForRoute.find(p => p.id === proc._id);
                return `
                    <button onclick="toggleProcessForRoute('${proc._id}')" 
                        class="process-chip ${colorClasses[proc.color]} border ${isSelected ? 'ring-2 ring-blue-500' : ''} rounded-lg px-3 py-1 text-sm transition"
                        title="${proc.description}">
                        ${proc.name}
                    </button>
                `;
            }).join('');

            renderSelectedProcessRoute();
        }

        async function toggleProcessForRoute(processId) {
            const processes = await apiCall('/processes', 'GET');
            const process = processes.find(p => p._id === processId);
            
            if (!process) return;

            const existingIndex = selectedProcessesForRoute.findIndex(p => p.id === processId);
            if (existingIndex >= 0) {
                selectedProcessesForRoute.splice(existingIndex, 1);
            } else {
                selectedProcessesForRoute.push({ 
                    id: process._id,
                    name: process.name,
                    code: process.code,
                    description: process.description,
                    color: process.color
                });
            }

            renderAvailableProcessesForItem();
        }

        function renderSelectedProcessRoute() {
            const container = document.getElementById('selectedProcessRoute');
            const emptyMessage = document.getElementById('emptyRouteMessage');

            if (selectedProcessesForRoute.length === 0) {
                container.innerHTML = '';
                emptyMessage.classList.remove('hidden');
                return;
            }

            emptyMessage.classList.add('hidden');

            const colorClasses = {
                gray: 'bg-gray-500 text-white',
                red: 'bg-red-500 text-white',
                orange: 'bg-orange-500 text-white',
                amber: 'bg-amber-500 text-white',
                green: 'bg-green-500 text-white',
                teal: 'bg-teal-500 text-white',
                blue: 'bg-blue-500 text-white',
                indigo: 'bg-indigo-500 text-white',
                purple: 'bg-purple-500 text-white',
                pink: 'bg-pink-500 text-white'
            };

            container.innerHTML = selectedProcessesForRoute.map((proc, index) => `
                <div class="sortable-item flex items-center gap-2 ${colorClasses[proc.color]} rounded-lg px-3 py-2 text-white cursor-move" 
                     draggable="true" 
                     ondragstart="dragStart(event, ${index})"
                     ondragover="dragOver(event)"
                     ondrop="drop(event, ${index})">
                    <i class="fas fa-grip-vertical opacity-50"></i>
                    <span class="font-bold">${index + 1}.</span>
                    <span>${proc.name}</span>
                    <button onclick="removeProcessFromRoute(${index})" class="ml-2 hover:text-red-200 transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeProcessFromRoute(index) {
            selectedProcessesForRoute.splice(index, 1);
            renderAvailableProcessesForItem();
        }

        // Drag and drop
        let draggedIndex = null;

        function dragStart(event, index) {
            draggedIndex = index;
            event.target.classList.add('dragging');
        }

        function dragOver(event) {
            event.preventDefault();
        }

        function drop(event, dropIndex) {
            event.preventDefault();
            if (draggedIndex === null || draggedIndex === dropIndex) return;

            const item = selectedProcessesForRoute.splice(draggedIndex, 1)[0];
            selectedProcessesForRoute.splice(dropIndex, 0, item);
            
            draggedIndex = null;
            renderAvailableProcessesForItem();
        }

        async function addItem() {
            const name = document.getElementById('itemName').value.trim();
            const code = document.getElementById('itemCode').value.trim();
            const spec = document.getElementById('itemSpec').value.trim();
            const material = document.getElementById('itemMaterial').value.trim();
            const category = document.getElementById('itemCategory').value.trim();

            if (!name || !code) {
                showToast('Please enter item name and code', 'error');
                return;
            }

            if (selectedProcessesForRoute.length === 0) {
                showToast('Please select at least one process for the route', 'error');
                return;
            }

            const item = {
                name,
                code,
                specifications: spec,
                material,
                category,
                processRoute: selectedProcessesForRoute.map((proc, index) => ({
                    ...proc,
                    order: index + 1
                }))
            };

            await apiCall('/items', 'POST', item);
            clearItemForm();
            await renderItemsList();
            await updateStats();
            showToast(`Item "${name}" saved with ${selectedProcessesForRoute.length} processes!`);
        }

        function clearItemForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('itemCode').value = '';
            document.getElementById('itemSpec').value = '';
            document.getElementById('itemMaterial').value = '';
            document.getElementById('itemCategory').value = '';
            selectedProcessesForRoute = [];
            renderAvailableProcessesForItem();
        }

        async function deleteItem(itemId) {
            if (!confirm('Delete this item? Related batches will not be affected.')) return;
            
            await apiCall(`/items/${itemId}`, 'DELETE');
            await renderItemsList();
            await updateStats();
            showToast('Item deleted');
        }

        async function renderItemsList() {
            const container = document.getElementById('itemsList');
            const items = await apiCall('/items', 'GET');
            
            if (items.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No items added yet. Create your first item above.</p>';
                return;
            }

            const colorClasses = {
                gray: 'bg-gray-100 text-gray-800',
                red: 'bg-red-100 text-red-800',
                orange: 'bg-orange-100 text-orange-800',
                amber: 'bg-amber-100 text-amber-800',
                green: 'bg-green-100 text-green-800',
                teal: 'bg-teal-100 text-teal-800',
                blue: 'bg-blue-100 text-blue-800',
                indigo: 'bg-indigo-100 text-indigo-800',
                purple: 'bg-purple-100 text-purple-800',
                pink: 'bg-pink-100 text-pink-800'
            };

            container.innerHTML = items.map(item => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">${item.name}</h3>
                            <p class="text-sm text-gray-600">Code: ${item.code}</p>
                            ${item.material ? `<span class="inline-block mt-1 text-xs bg-gray-100 px-2 py-1 rounded">${item.material}</span>` : ''}
                            ${item.category ? `<span class="inline-block mt-1 text-xs bg-green-100 text-green-800 px-2 py-1 rounded ml-1">${item.category}</span>` : ''}
                        </div>
                        <button onclick="deleteItem('${item._id}')" class="text-red-600 hover:text-red-800 p-2" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    ${item.specifications ? `<p class="text-sm text-gray-500 mb-3">${item.specifications}</p>` : ''}
                    <div>
                        <p class="text-sm font-medium text-gray-700 mb-2"><i class="fas fa-route mr-1"></i>Process Route (${item.processRoute.length} steps):</p>
                        <div class="flex flex-wrap gap-1">
                            ${item.processRoute.map((proc, i) => `
                                <span class="${colorClasses[proc.color]} text-xs px-2 py-1 rounded">
                                    ${i + 1}. ${proc.name}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ============ BATCH MANAGEMENT ============
        async function updateBatchItemSelect() {
            const select = document.getElementById('batchItemSelect');
            const items = await apiCall('/items', 'GET');
            select.innerHTML = '<option value="">-- Select Item --</option>' + 
                items.map(item => `<option value="${item._id}">${item.name} (${item.code})</option>`).join('');
        }

        async function previewBatchProcessRoute() {
            const itemId = document.getElementById('batchItemSelect').value;
            const preview = document.getElementById('processRoutePreview');
            const routeSteps = document.getElementById('routePreviewSteps');

            if (!itemId) {
                preview.classList.add('hidden');
                return;
            }

            const items = await apiCall('/items', 'GET');
            const item = items.find(i => i._id === itemId);
            
            if (!item || item.processRoute.length === 0) {
                preview.classList.add('hidden');
                return;
            }

            preview.classList.remove('hidden');
            
            const colorClasses = {
                gray: 'border-l-gray-400 bg-gray-50',
                red: 'border-l-red-400 bg-red-50',
                orange: 'border-l-orange-400 bg-orange-50',
                amber: 'border-l-amber-400 bg-amber-50',
                green: 'border-l-green-400 bg-green-50',
                teal: 'border-l-teal-400 bg-teal-50',
                blue: 'border-l-blue-400 bg-blue-50',
                indigo: 'border-l-indigo-400 bg-indigo-50',
                purple: 'border-l-purple-400 bg-purple-50',
                pink: 'border-l-pink-400 bg-pink-50'
            };

            routeSteps.innerHTML = `
                <div class="flex items-center gap-2 flex-wrap">
                    ${item.processRoute.map((proc, i) => `
                        <div class="flex items-center">
                            <div class="border-l-4 ${colorClasses[proc.color]} rounded-r-lg px-3 py-2">
                                <span class="font-semibold text-sm">${proc.name}</span>
                            </div>
                            ${i < item.processRoute.length - 1 ? '<i class="fas fa-chevron-right text-gray-400 mx-1"></i>' : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function createBatch() {
            const batchNumber = document.getElementById('batchNumber').value.trim();
            const quantity = parseInt(document.getElementById('batchQuantity').value);
            const itemId = document.getElementById('batchItemSelect').value;
            const priority = document.getElementById('batchPriority').value;
            const targetDate = document.getElementById('batchTargetDate').value;
            const customer = document.getElementById('batchCustomer').value.trim();

            if (!batchNumber || !quantity || !itemId) {
                showToast('Please fill all required batch details', 'error');
                return;
            }

            const items = await apiCall('/items', 'GET');
            const item = items.find(i => i._id === itemId);

            const batch = {
                batchNumber,
                quantity,
                priority,
                targetDate,
                customer,
                itemId,
                itemName: item.name,
                itemCode: item.code,
                processes: item.processRoute.map(proc => ({
                    ...proc,
                    status: 'pending',
                    startTime: null,
                    endTime: null,
                    notes: ''
                }))
            };

            await apiCall('/batches', 'POST', batch);
            clearBatchForm();
            await renderBatchesList();
            await updateStats();
            showToast(`Batch "${batchNumber}" created!`);
        }

        function clearBatchForm() {
            document.getElementById('batchNumber').value = '';
            document.getElementById('batchQuantity').value = '';
            document.getElementById('batchItemSelect').value = '';
            document.getElementById('batchPriority').value = 'normal';
            document.getElementById('batchTargetDate').value = '';
            document.getElementById('batchCustomer').value = '';
            document.getElementById('processRoutePreview').classList.add('hidden');
        }

        async function deleteBatch(batchId) {
            if (!confirm('Delete this batch?')) return;
            
            await apiCall(`/batches/${batchId}`, 'DELETE');
            await renderBatchesList();
            await updateTrackingBatchSelect();
            await updateStats();
            showToast('Batch deleted');
        }

        async function filterBatches() {
            await renderBatchesList();
        }

        async function renderBatchesList() {
            const container = document.getElementById('batchesList');
            const filter = document.getElementById('batchFilter').value;
            const batches = await apiCall('/batches', 'GET');
            
            let filteredBatches = [...batches];
            if (filter === 'active') filteredBatches = filteredBatches.filter(b => !b.completedAt);
            if (filter === 'completed') filteredBatches = filteredBatches.filter(b => b.completedAt);

            if (filteredBatches.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-3">No batches found.</p>';
                return;
            }

            const priorityColors = {
                normal: 'bg-gray-100 text-gray-800',
                high: 'bg-orange-100 text-orange-800',
                urgent: 'bg-red-100 text-red-800'
            };

            container.innerHTML = filteredBatches.map(batch => {
                const completed = batch.processes.filter(p => p.status === 'completed').length;
                const total = batch.processes.length;
                const progress = Math.round((completed / total) * 100);
                const isComplete = batch.completedAt !== null;

                return `
                    <div class="batch-card border border-gray-200 rounded-lg p-4 ${isComplete ? 'bg-green-50' : 'bg-white'}">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-gray-800">${batch.batchNumber}</h3>
                            <span class="text-xs px-2 py-1 rounded ${priorityColors[batch.priority]}">${batch.priority}</span>
                        </div>
                        <p class="text-sm text-gray-600">${batch.itemName} (${batch.itemCode})</p>
                        <p class="text-sm font-medium text-blue-600 mt-1">Qty: ${batch.quantity}</p>
                        ${batch.customer ? `<p class="text-xs text-gray-500 mt-1"><i class="fas fa-user mr-1"></i>${batch.customer}</p>` : ''}
                        <div class="mt-3">
                            <div class="flex justify-between text-xs text-gray-600 mb-1">
                                <span>Progress</span>
                                <span>${completed}/${total} steps (${progress}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-gradient-to-r from-blue-500 to-green-500 h-2 rounded-full transition-all" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        <div class="mt-3 flex gap-2">
                            <button onclick="trackBatch('${batch._id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm transition">
                                <i class="fas fa-tasks mr-1"></i>Track
                            </button>
                            <button onclick="deleteBatch('${batch._id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm transition">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============ TRACKING ============
        async function updateTrackingBatchSelect() {
            const select = document.getElementById('trackingBatchSelect');
            const batches = await apiCall('/batches', 'GET');
            select.innerHTML = '<option value="">-- Select Batch --</option>' + 
                batches.map(batch => `<option value="${batch._id}">${batch.batchNumber} - ${batch.itemName}</option>`).join('');
        }

        async function loadBatchTracking() {
            const batchId = document.getElementById('trackingBatchSelect').value;
            const display = document.getElementById('trackingDisplay');
        
            if (!batchId) {
                display.classList.add('hidden');
                return;
            }
        
            display.classList.remove('hidden');
            const batches = await apiCall('/batches', 'GET');
            const batch = batches.find(b => b._id === batchId);
        
            if (!batch) {
                display.innerHTML = '<p class="text-red-500">Batch not found</p>';
                return;
            }
        
            // Batch info
            const priorityColors = { normal: 'bg-gray-100', high: 'bg-orange-100', urgent: 'bg-red-100' };
            document.getElementById('batchInfo').innerHTML = `
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="text-2xl font-bold">${batch.batchNumber}</div>
                    <span class="px-3 py-1 rounded ${priorityColors[batch.priority]} text-sm font-medium">${batch.priority} priority</span>
                    <span class="text-sm text-gray-700">${batch.itemName} (${batch.itemCode})</span>
                    <span class="text-sm text-gray-700">Qty: ${batch.quantity}</span>
                    ${batch.customer ? `<span class="text-sm text-gray-700"><i class="fas fa-user mr-1"></i>${batch.customer}</span>` : ''}
                </div>
            `;
        
            // Progress
            const completed = batch.processes.filter(p => p.status === 'completed').length;
            const total = batch.processes.length;
            const progress = Math.round((completed / total) * 100);
            document.getElementById('overallProgressText').textContent = `${progress}%`;
            document.getElementById('overallProgressBar').style.width = `${progress}%`;
        
            // Process tracking
            const trackingContainer = document.getElementById('processTracking');
            trackingContainer.innerHTML = batch.processes.map((proc, index) => {
                const statusClass = `status-${proc.status}`;
                const statusIcon = proc.status === 'pending' ? 'fa-clock text-amber-500' :
                                  proc.status === 'inprogress' ? 'fa-spinner fa-spin text-blue-500' :
                                  proc.status === 'completed' ? 'fa-check-circle text-green-500' :
                                  'fa-exclamation-circle text-red-500';
                const statusText = proc.status.charAt(0).toUpperCase() + proc.status.slice(1).replace('inprogress', 'In Progress');
        
                return `
                    <div class="${statusClass} rounded-lg p-4 border-r-4">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-3">
                                <span class="bg-white rounded-full w-10 h-10 flex items-center justify-center font-bold text-gray-800 shadow">${proc.order}</span>
                                <div>
                                    <span class="font-bold text-gray-800 text-lg">${proc.name}</span>
                                    ${proc.description ? `<p class="text-sm text-gray-600">${proc.description}</p>` : ''}
                                </div>
                            </div>
                            <span class="flex items-center gap-2 font-semibold text-sm px-3 py-1 rounded-full bg-white">
                                <i class="fas ${statusIcon}"></i>
                                ${statusText}
                            </span>
                        </div>
                        <div class="ml-13 space-y-3">
                            <div class="flex gap-2 flex-wrap">
                                <button type="button" onclick="event.preventDefault(); event.stopPropagation(); updateProcessStatus('${batch._id}', ${index}, 'pending'); return false;" class="px-4 py-2 rounded text-sm bg-yellow-100 hover:bg-yellow-200 text-yellow-800 transition">
                                    <i class="fas fa-clock mr-1"></i>Pending
                                </button>
                                <button type="button" onclick="event.preventDefault(); event.stopPropagation(); updateProcessStatus('${batch._id}', ${index}, 'inprogress'); return false;" class="px-4 py-2 rounded text-sm bg-blue-100 hover:bg-blue-200 text-blue-800 transition">
                                    <i class="fas fa-play mr-1"></i>In Progress
                                </button>
                                <button type="button" onclick="event.preventDefault(); event.stopPropagation(); updateProcessStatus('${batch._id}', ${index}, 'completed'); return false;" class="px-4 py-2 rounded text-sm bg-green-100 hover:bg-green-200 text-green-800 transition">
                                    <i class="fas fa-check mr-1"></i>Completed
                                </button>
                                <button type="button" onclick="event.preventDefault(); event.stopPropagation(); updateProcessStatus('${batch._id}', ${index}, 'defect'); return false;" class="px-4 py-2 rounded text-sm bg-red-100 hover:bg-red-200 text-red-800 transition">
                                    <i class="fas fa-exclamation mr-1"></i>Defect
                                </button>
                            </div>
                            <input type="text" placeholder="Add notes..." value="${proc.notes || ''}" 
                                onchange="event.preventDefault(); updateProcessNotes('${batch._id}', ${index}, this.value); return false;"
                                class="border border-gray-300 rounded px-4 py-2 text-sm w-full" />
                            <div class="text-xs text-gray-500 flex gap-4">
                                ${proc.startTime ? `<span><i class="fas fa-play mr-1"></i>Started: ${new Date(proc.startTime).toLocaleString()}</span>` : ''}
                                ${proc.endTime ? `<span><i class="fas fa-check mr-1"></i>Ended: ${new Date(proc.endTime).toLocaleString()}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        
            renderBatchSummary();
        }

        async function updateProcessStatus(batchId, processIndex, status) {
            try {
                const batches = await apiCall('/batches', 'GET');
                const batch = batches.find(b => b._id === batchId);
                
                if (!batch) {
                    showToast('Batch not found', 'error');
                    return;
                }
                
                const proc = batch.processes[processIndex];
        
                const updates = {
                    status: status,
                    endTime: status === 'completed' ? new Date().toISOString() : (status === 'pending' ? null : proc.endTime),
                    startTime: status === 'inprogress' ? (proc.startTime || new Date().toISOString()) : (status === 'pending' ? null : proc.startTime)
                };
        
                // Use query parameters instead of path parameters
                await apiCall(`/batches?id=${batchId}&processIndex=${processIndex}&action=updateProcess`, 'PUT', updates);
                
                // Re-render only the tracking display, don't reload the page
                await loadBatchTracking();
                await renderBatchesList();
                await updateStats();
                
                showToast('Process status updated', 'success');
            } catch (error) {
                console.error('Failed to update process status:', error);
                showToast('Failed to update status', 'error');
            }
        }

        async function updateProcessNotes(batchId, processIndex, notes) {
            try {
                await apiCall(`/batches?id=${batchId}&processIndex=${processIndex}&action=updateProcess`, 'PUT', { notes });
                showToast('Notes saved', 'success');
            } catch (error) {
                console.error('Failed to update notes:', error);
            }
        }

        async function startFirstPendingProcess() {
            const batchId = document.getElementById('trackingBatchSelect').value;
            const batches = await apiCall('/batches', 'GET');
            const batch = batches.find(b => b._id === batchId);
            const pendingIndex = batch.processes.findIndex(p => p.status === 'pending');
            
            if (pendingIndex >= 0) {
                await updateProcessStatus(batchId, pendingIndex, 'inprogress');
            } else {
                showToast('All processes are already started!', 'info');
            }
        }

        async function completeCurrentProcess() {
            const batchId = document.getElementById('trackingBatchSelect').value;
            const batches = await apiCall('/batches', 'GET');
            const batch = batches.find(b => b._id === batchId);
            const inProgressIndex = batch.processes.findIndex(p => p.status === 'inprogress');
            
            if (inProgressIndex >= 0) {
                await updateProcessStatus(batchId, inProgressIndex, 'completed');
                
                // Auto-start next process
                const nextIndex = batch.processes.findIndex((p, i) => i > inProgressIndex && p.status === 'pending');
                if (nextIndex >= 0) {
                    await updateProcessStatus(batchId, nextIndex, 'inprogress');
                }
            } else {
                showToast('No process in progress!', 'info');
            }
        }

        async function resetAllProcesses() {
            if (!confirm('Reset all processes to pending?')) return;
            
            const batchId = document.getElementById('trackingBatchSelect').value;
            const batches = await apiCall('/batches', 'GET');
            const batch = batches.find(b => b._id === batchId);
            
            for (let i = 0; i < batch.processes.length; i++) {
                await updateProcessStatus(batchId, i, 'pending');
            }
            
            await loadBatchTracking();
            await renderBatchesList();
            showToast('All processes reset');
        }

        function trackBatch(batchId) {
            showTab('tracking');
            document.getElementById('trackingBatchSelect').value = batchId;
            loadBatchTracking();
        }

        async function renderBatchSummary() {
            const container = document.getElementById('batchSummary');
            const batches = await apiCall('/batches', 'GET');
            
            if (batches.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No batches created yet.</p>';
                return;
            }

            container.innerHTML = batches.map(batch => {
                const completed = batch.processes.filter(p => p.status === 'completed').length;
                const total = batch.processes.length;
                const isComplete = batch.completedAt !== null;
                const hasDefects = batch.processes.some(p => p.status === 'defect');
                
                let statusClass, statusText;
                if (isComplete) { statusClass = 'bg-green-100 text-green-800'; statusText = 'Completed'; }
                else if (hasDefects) { statusClass = 'bg-red-100 text-red-800'; statusText = 'Has Defects'; }
                else { statusClass = 'bg-blue-100 text-blue-800'; statusText = 'In Progress'; }

                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition cursor-pointer" onclick="trackBatch('${batch._id}')">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-gray-800">${batch.batchNumber}</h3>
                                <p class="text-sm text-gray-600">${batch.itemName}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${statusClass}">${statusText}</span>
                        </div>
                        <div class="mt-2 text-sm text-gray-600">Qty: ${batch.quantity} | ${completed}/${total} steps</div>
                        <div class="text-xs text-gray-400 mt-1">Created: ${new Date(batch.createdAt).toLocaleDateString()}</div>
                    </div>
                `;
            }).join('');
        }

        // ============ DASHBOARD ============
        async function renderDashboard() {
            const batches = await apiCall('/batches', 'GET');
            
            // Status chart
            const active = batches.filter(b => !b.completedAt).length;
            const completed = batches.filter(b => b.completedAt).length;
            const total = batches.length || 1;
            
            document.getElementById('statusChart').innerHTML = `
                <div class="text-center">
                    <div class="relative w-48 h-48 mx-auto">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="96" cy="96" r="88" stroke="#e5e7eb" stroke-width="20" fill="none"/>
                            <circle cx="96" cy="96" r="88" stroke="#3b82f6" stroke-width="20" fill="none"
                                stroke-dasharray="${(active/total) * 553} 553" stroke-linecap="round"/>
                            <circle cx="96" cy="96" r="88" stroke="#10b981" stroke-width="20" fill="none"
                                stroke-dasharray="${(completed/total) * 553} 553" stroke-dashoffset="${-(active/total) * 553}" stroke-linecap="round"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center flex-col">
                            <span class="text-3xl font-bold text-gray-800">${total}</span>
                            <span class="text-sm text-gray-500">Total Batches</span>
                        </div>
                    </div>
                    <div class="flex justify-center gap-6 mt-4">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                            <span class="text-sm">Active (${active})</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <span class="text-sm">Completed (${completed})</span>
                        </div>
                    </div>
                </div>
            `;

            // Defect report
            const defects = [];
            batches.forEach(batch => {
                batch.processes.forEach(proc => {
                    if (proc.status === 'defect') {
                        defects.push({ batch: batch.batchNumber, process: proc.name, item: batch.itemName });
                    }
                });
            });

            if (defects.length === 0) {
                document.getElementById('defectReport').innerHTML = '<p class="text-green-600 text-center py-8"><i class="fas fa-check-circle mr-2"></i>No defects reported!</p>';
            } else {
                document.getElementById('defectReport').innerHTML = defects.map(d => `
                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                        <div>
                            <span class="font-medium">${d.batch}</span>
                            <span class="text-gray-600 mx-2">-</span>
                            <span class="text-sm">${d.process}</span>
                        </div>
                        <span class="text-sm text-gray-500">${d.item}</span>
                    </div>
                `).join('');
            }

            // Recent activity
            const recentBatches = [...batches].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
            document.getElementById('recentActivity').innerHTML = recentBatches.length === 0 
                ? '<p class="text-gray-500 text-center py-4">No recent activity</p>'
                : recentBatches.map(batch => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-box text-blue-600"></i>
                            </div>
                            <div>
                                <p class="font-medium">${batch.batchNumber}</p>
                                <p class="text-sm text-gray-500">${batch.itemName} - Qty: ${batch.quantity}</p>
                            </div>
                        </div>
                        <span class="text-sm text-gray-400">${new Date(batch.createdAt).toLocaleDateString()}</span>
                    </div>
                `).join('');

            // Top items
            const itemStats = {};
            batches.forEach(batch => {
                if (!itemStats[batch.itemName]) {
                    itemStats[batch.itemName] = { count: 0, qty: 0 };
                }
                itemStats[batch.itemName].count++;
                itemStats[batch.itemName].qty += batch.quantity;
            });

            const topItems = Object.entries(itemStats)
                .sort((a, b) => b[1].qty - a[1].qty)
                .slice(0, 3);

            document.getElementById('topItems').innerHTML = topItems.length === 0
                ? '<p class="text-gray-500 text-center py-4 col-span-3">No data yet</p>'
                : topItems.map(([name, stats], i) => `
                    <div class="p-4 bg-gradient-to-br from-yellow-50 to-amber-50 rounded-lg border border-yellow-200">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-2xl">${['ü•á', 'ü•à', 'ü•â'][i]}</span>
                            <h4 class="font-bold">${name}</h4>
                        </div>
                        <p class="text-sm text-gray-600">${stats.count} batches | ${stats.qty} total units</p>
                    </div>
                `).join('');
        }

        // ============ DATA IMPORT/EXPORT ============
        async function exportData() {
            const data = {
                processes: await apiCall('/processes', 'GET'),
                items: await apiCall('/items', 'GET'),
                batches: await apiCall('/batches', 'GET')
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `auto-parts-pro-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showToast('Data exported successfully!');
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (confirm('This will add data to your database. Continue?')) {
                        // Import processes
                        if (imported.processes) {
                            for (const proc of imported.processes) {
                                delete proc._id; // Let MongoDB assign new IDs
                                await apiCall('/processes', 'POST', proc);
                            }
                        }
                        // Import items
                        if (imported.items) {
                            for (const item of imported.items) {
                                delete item._id;
                                await apiCall('/items', 'POST', item);
                            }
                        }
                        // Import batches
                        if (imported.batches) {
                            for (const batch of imported.batches) {
                                delete batch._id;
                                await apiCall('/batches', 'POST', batch);
                            }
                        }
                        
                        await renderAllData();
                        await updateStats();
                        showToast('Data imported successfully!');
                    }
                } catch (err) {
                    showToast('Invalid file format', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        async function renderAllData() {
            await renderProcessesList();
            await renderItemsList();
            await renderBatchesList();
            await renderBatchSummary();
            await updateBatchItemSelect();
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            updateTime();
            setInterval(updateTime, 1000);
            
            const apiOnline = await checkAPIStatus();
            if (apiOnline) {
                await updateStats();
                await renderProcessesList(); // Add this line - load processes on startup
            } else {
                // Still show stats if using localStorage
                await updateStats();
                await renderProcessesList(); // Add this line
            }
        });
    </script>
</body>
</html>
